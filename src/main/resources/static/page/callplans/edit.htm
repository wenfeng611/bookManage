<div class="layui-tab layui-tab-import">
    <ul class="layui-tab-title">
        <li class="layui-this">外呼设置</li>
        <li onclick="initTable();">外呼任务</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
            <div class="uk-layui-form">
                <form class="layui-form callplan-edit-form">
                    <div class="layui-collapse">
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">计划设置<span class="required">（* 表示必填项）</span></h2>
                            <div class="layui-colla-content layui-show">
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>计划名称：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="name" id="name" required="" lay-verify="required" autocomplete="off" class="layui-input">
                                        </div>
                                    </div>
                                </div>

                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>开始时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="starttime" id="starttime" readOnly="readOnly" lay-verify="required" autocomplete="off"
                                                   class="layui-input">
                                            <i class="layui-icon" style="position: absolute;right: 3px;top: 6px;font-size: 25px;">&#xe637;</i>
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>结束时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="endtime" id="endtime" readOnly="readOnly" lay-verify="required" autocomplete="off"
                                                   class="layui-input">
                                            <i class="layui-icon" style="position: absolute;right: 3px;top: 6px;font-size: 25px;">&#xe637;</i>
                                        </div>
                                    </div>
                                </div>

                                <div class="layui-form-item callplan-task-type">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>任务类型：</label>
                                        <div class="layui-inline">
                                            <div class="layui-input-block" style="padding-top:3px;">
                                                <input type="radio" name="tasktype" value="0" title="自动外呼" checked>
                                                <!--<input type="radio" name="tasktype" value="1" title="语音外呼">-->
                                                <input type="radio" name="tasktype" value="2" title="点击外呼">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item layui-hide">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>接听队列：</label>
                                        <div class="layui-input-inline">
                                            <select id="receviequeue" name="receviequeue" lay-ignore="" style="display: inline-block;">
                                                <option value="">请选择...</option>
                                                <option value="1">测试队列</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item  layui-hide">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>呼出外线：</label>
                                        <div class="layui-input-inline">
                                            <select id="calloutline" name="calloutline" lay-ignore="" style="display: inline-block;">
                                                <option value="">请选择...</option>
                                                <option value="1">测试外线</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-inline layui-hide">
                                        <label class="layui-form-label"><span class="required">* </span>呼叫主叫：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="calloutnumber" id="calloutnumber" required="" autocomplete="off" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item callplan-control-type">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>控制类型：</label>
                                        <div class="layui-inline">
                                            <div class="layui-input-block" style="padding-top:3px;">
                                                <input type="radio" name="controltype" value="0" title="标准外呼" checked>
                                                <input type="radio" name="controltype" value="1" title="智能外呼">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item layui-hide">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"><span class="required">* </span>最大并发：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="maxconcurrent" id="maxconcurrent" required="" lay-verify="number|required" autocomplete="off" class="layui-input" value="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label">任务备注：</label>
                                        <div class="layui-input-inline" style="width:520px;">
                                            <textarea name="memo" id="memo" placeholder="请输入内容" class="layui-textarea"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-button">
                        <div class="layui-button-block">
                            <button class="layui-btn" lay-submit="" lay-filter="updatePlan">更新计划</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            <button class="layui-btn layui-btn-primary close-layerwin-window">关闭</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="layui-tab-item">
            <div class="uk-layui-form">
                <!--<form class="layui-form">-->
                    <div class="layui-collapse" style="width: 930px; height: 430px; overflow-y: scroll;">
                        <table id="dt-delete-task" class="table table-striped table-bordered table-hover" width="100%">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="layui-form-button">
                        <div class="layui-button-block">
                            <button class="layui-btn" lay-submit="" lay-filter="deletetasks">删除任务</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            <button class="layui-btn layui-btn-primary close-layerwin-window">关闭</button>
                        </div>
                    </div>
                <!--</form>-->
            </div>
        </div>
    </div>
</div>

<script>

    var thisParent = top.window.frm_callplans;

    $('.callplan-task-type').click(function(){
        root.Console.log($(this), $(this).find('input[type=radio][name=tasktype]:checked'));
        var type = $(this).find('input[type=radio][name=tasktype]:checked').val();
        root.Console.log('type', type);
        if(type === '0' || type === '2'){
            $('.callplan-control-type').toggleClass('layui-hide');
        }
    });

        ajaxSetup();
        layui.use('laydate', function () {
            var laydate = layui.laydate;

            var start = {
                min: laydate.now()
                , istoday: false
                , istime: true
                , format: 'YYYY-MM-DD hh:mm:ss'
                , choose: function (datas) {
                    end.min = datas; //开始日选好后，重置结束日的最小日期
                    end.start = datas //将结束日的初始值设定为开始日
                }
            };


            var end = {
                min: laydate.now()
                , format: 'YYYY-MM-DD hh:mm:ss'
                , istoday: false
                , istime: true
                , choose: function (datas) {
                    start.max = datas; //结束日选好后，重置开始日的最大日期
                }
            };

            document.getElementById('starttime').onclick = function () {
                start.elem = this;
                laydate(start);
            }
            document.getElementById('endtime').onclick = function () {
                end.elem = this;
                laydate(end);
            }


            /*
            laydate.render({
                elem: '#starttime'
                ,format: 'yyyy-MM-dd HH:mm:ss'
                ,type: 'datetime'
                ,min: new Date().Format('yyyy-MM-dd hh:mm:ss')
//                ,show: true //直接显示
//                ,calendar: true
            });
            laydate.render({
                elem: '#endtime'
                ,format: 'yyyy-MM-dd HH:mm:ss'
                ,type: 'datetime'
                ,min: new Date().Format('yyyy-MM-dd hh:mm:ss')
            });
            */
        });

    var taskTable = undefined;

    var initTable = function () {

        taskTable = thisParent.commonDataTable({
            "columns": [
                {
                    title: "<nobr><input type=checkbox id='checkControll' name='checkControll'> 全选</nobr>",
                    data: "id",
                    orderable: false,
                    width: '1%',
                    render: function (data, style, full) {
                        return '<div class="layui-input-block"><input type="checkbox" title="" id="' + data + '" name="' + data + '"></div>';
                    }
                },
                {
                    title: "电话", data: "mobile", orderable: false, render: function (data, style, full) {
                    var phone = new Array();
                    if (full.mobile) {
                        phone.push(full.mobile);
                    }
                    if (full.mobilealt) {
                        phone.push(full.mobilealt);
                    }
                    if (full.phone) {
                        phone.push(full.phone);
                    }
                    if (full.phonealt) {
                        phone.push(full.phonealt);
                    }

                    return phone.join("<br>");
                }
                },
                {title: "姓名", data: "uname",},
                {title: "公司", data: "company",},
                {title: "受理人", data: "ownername",},
                {
                    title: "状态", data: "status", render: function (data, style, full) {
                    return data == 1 ? "完成" : "未完成";
                }
                },
            ],

            "fnServerData": function (sSource, aoData, fnCallback) {

                var start = 0;
                var length = 10;
                var columns = null;
                var sEcho = 1;
                var order = [];
                $.each(aoData, function (i, item) {
                    var name = item['name'];
                    var value = item['value'];
                    if (name == "start") {
                        start = value;
                    } else if (name == 'length') {
                        length = value;
                    } else if (name == 'draw') {
                        sEcho = value;
                    } else if (name == 'order') {
                        order = value;
                    } else if (name == 'columns') {
                        columns = value;
                    }
                });

                var orderby = columns[order[0].column].data;
                var direction = order[0].dir;

                var postData = {};
                postData.orderby = orderby ? orderby : "ownername";
                postData.direction = direction ? direction : "desc";
                postData.ps = length ? length : 20;
                postData.p = 1 + (start ? start / postData.ps : 0);

                root.Console.log(postData);
                $.get("/restapi/callplans/" + thisParent.planid + "/calltasks?type=uncompleted", postData, function (data) {

                    var content = data;
                    if (!content) {
                        content = {paging: {count: 0, limit: 10, offset: 0}};
                    }
                    content['sEcho'] = sEcho;
                    content['iDisplayStart'] = content.paging.offset;
                    content['iDisplayLength'] = content.paging.limit;
                    content['iTotalRecords'] = content.paging.count;
                    content['iTotalDisplayRecords'] = content.paging.count;
                    content['sortField'] = orderby; //"createTime";
                    content['sortType'] = direction;
                    fnCallback(content);
                }).done(function (data) {
                    //log('done');
                }).fail(function (data) {
                    if (data.status === 403) {
                        root.Console.log("current request need login!");
                    }
                }).always(function () {
                    //log('always');
                });
            },
            drawCallback: function () {
                layui.use('form', function() {
                    var form = layui.form();
                    form.render();
                });
            },
            "orderby": "ownername",
            "table": $('#dt-delete-task'),
        });
    }

    function loadData() {

        $.get("/restapi/callplans/" + thisParent.planid, {}, function (data) {
            root.Console.log(data);
            $.each($('.callplan-edit-form input[type=text], .callplan-edit-form textarea, .callplan-edit-form select'), function (i, item) {
                $(this).val(data[$(this).attr('id')]);
            });
            $.each($('.callplan-edit-form input[type=radio]'), function(i, item){
                var name = $(this).attr('name');
                var value = data[name];
                $(".callplan-edit-form input[type=radio][name='" + name + "'][value='" + value + "']").prop("checked",true);
                layui.use('form', function () {
                    var form = layui.form();
                    form.render();//更新全部
                });
            });

            $('.callplan-task-type').click();
        });

    }

    layui.use('layer', function () {
        var layer = layui.layer;

        $('.close-layerwin-window').click(function () {
            layer.close(top.layerwin);
        });
    });

//    $(function () {
        layui.use(['form', 'element'], function () {
            var form = layui.form()
                , element = layui.element();

            var disable = false;
            var deletedisable = false;
            form.on
            (
                "submit(updatePlan)", function (data) {

                    if(disable){
                        return false;
                    }
                    disable = true;

                    root.Console.log("update plan!", data.field);

                    $.post("/restapi/callplans/" + thisParent.planid, JSON.stringify(data.field), function (data) {
                        root.Console.log('done');
                    }).done(function (data) {
                        root.Console.log("submit done!");
                        thisParent.planListTable.fnDraw();
                        layer.close(top.layerwin);
                    }).fail(function (data) {
                        root.Console.log(data);
                    }).always(function () {
                        disable = false;
                    });
                    return false;
                });

            form.on('submit(deletetasks)', function(data){
                console.log('deletetasks', data);
                if(deletedisable){
                    return;
                }
                deletedisable = true;

                var deleteTasks = new Array();
                $.each($('#dt-delete-task input[type=checkbox][name!=checkControll]:checked'), function(i, item){
                    deleteTasks.push($(this).attr('id'));
                });
                if(deleteTasks && deleteTasks.length > 0) {
                    $.post("/restapi/callplans/" + thisParent.planid  + "/calltasks/delete", JSON.stringify(deleteTasks), function (data) {
                        root.Console.log('done');
                    }).done(function (data) {
                        root.Console.log("submit done!");
                        taskTable.fnDraw();
                        thisParent.planListTable.fnDraw();
                    }).fail(function (data) {
                        root.Console.log(data);
                    }).always(function () {
                        deletedisable = false;
                    });
                }else{
                    deletedisable = false;
                }
                return false;
            });
        });

    $('#dt-delete-task').delegate('input#checkControll', 'click', function () {
        if ($(this).is(':checked')) {
            $('#dt-delete-task input[type=checkbox][name!=checkControll]').prop('checked', true);
        } else {
            $('#dt-delete-task input[type=checkbox][name!=checkControll]').prop('checked', false);
        }
    });

        loadData();
//    })
</script>