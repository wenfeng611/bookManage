
<div class="row">
    <div class="col-lg-12">
        <h1 class="site-h1">
            工单概况
            <span style="float:right;">
                            <a class="layui-btn layui-btn-small green" href="/page/workorders/add.htm" title="创建新工单">
                                <i class="layui-icon"></i>
                                创建新工单
                            </a>
                        </span>
        </h1>

        <div class="row">
            <div class="col-lg-3">
                <div class="ukefu-measure">
                    <a href="javascript:void(0)" class="ukefu-bt">
                        <i class="kfont ukewo-btn ukefu-measure-btn"></i>
                        <div class="ukefu-bt-text">
                            <div class="ukefu-bt-text-title workorder-total" style="font-weight:400;font-size:19px;"></div>
                            <div class="ukefu-bt-text-content" style="">工单总数</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="ukefu-measure">
                    <a href="javascript:void(0)" class="ukefu-bt">
                        <i class="kfont ukewo-btn ukefu-measure-btn ukefu-bg-color-yellow"></i>
                        <div class="ukefu-bt-text">
                            <div class="ukefu-bt-text-title workorder-open" style="font-weight:400;font-size:19px;"></div>
                            <div class="ukefu-bt-text-content" style="">未关闭工单总数</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="ukefu-measure">
                    <a href="/apps/workorders/myorders.html" class="ukefu-bt">
                        <i class="kfont ukewo-btn ukefu-measure-btn ukefu-bg-color-pink"></i>
                        <div class="ukefu-bt-text">
                            <div class="ukefu-bt-text-title workorder-mine" style="font-weight:400;font-size:19px;"></div>
                            <div class="ukefu-bt-text-content" style="">我的工单总数</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="ukefu-measure">
                    <a href="/apps/workorders/workitem.html" class="ukefu-bt">
                        <i class="kfont ukewo-btn ukefu-measure-btn ukefu-bg-color-green"></i>
                        <div class="ukefu-bt-text">
                            <div class="ukefu-bt-text-title workorder-myhold" style="font-weight:400;font-size:19px;"></div>
                            <div class="ukefu-bt-text-content" style="">我的待办工单总数</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <div class="row layui-hide">
            <div class="col-lg-6" style="padding-right:5px;">
                <div class="box">
                    <div class="box-title">
                        <h1 class="site-h1" style="background-color:#EEEEEE;">工单类型分布</h1>
                    </div>
                    <div class="box-body" style="padding:5px;">
                        <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
                        <div id="osname" style="width: 100%; height: 200px; -webkit-tap-highlight-color: transparent; user-select: none; position: relative; background: rgba(255, 255, 255, 0);" _echarts_instance_="ec_1504074760798"><div style="position: relative; overflow: hidden; width: 668px; height: 199px; padding: 0px; margin: 0px; border-width: 0px; cursor: default;"><canvas width="668" height="199" data-zr-dom-id="zr_0" style="position: absolute; left: 0px; top: 0px; width: 668px; height: 199px; user-select: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); padding: 0px; margin: 0px; border-width: 0px;"></canvas></div><div></div></div>
                        <script type="text/javascript">
                            // 基于准备好的dom，初始化echarts实例
                            var osnamechart = echarts.init(document.getElementById('osname') , 'wonderland');

                            var osnamechart_option = {
                                title : {
                                    text: '工单类型',
                                    x:'center'
                                },
                                tooltip : {
                                    trigger: 'item',
                                    formatter: "{a} <br/>{b} : {c} ({d}%)"
                                },
                                legend: {
                                    orient: 'vertical',
                                    left: 'left',
                                    data: []
                                },
                                series : [
                                    {
                                        name: '工单类型',
                                        type: 'pie',
                                        radius : '55%',
                                        center: ['50%', '60%'],
                                        data:[

                                        ],
                                        itemStyle: {
                                            emphasis: {
                                                shadowBlur: 10,
                                                shadowOffsetX: 0,
                                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                                            }
                                        }
                                    }
                                ]
                            };

                            // 使用刚指定的配置项和数据显示图表。
                            osnamechart.setOption(osnamechart_option);

                        </script>
                    </div>
                </div>
            </div>
            <div class="col-lg-6" style="padding-left:5px;">
                <div class="box">
                    <div class="box-title">
                        <h1 class="site-h1" style="background-color:#EEEEEE;">工单状态分布</h1>
                    </div>
                    <div class="box-body" style="padding:5px;">
                        <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
                        <div id="browser" style="width: 100%; height: 200px; -webkit-tap-highlight-color: transparent; user-select: none; position: relative; background: rgba(255, 255, 255, 0);" _echarts_instance_="ec_1504074760799"><div style="position: relative; overflow: hidden; width: 668px; height: 199px; padding: 0px; margin: 0px; border-width: 0px;"><canvas width="668" height="199" data-zr-dom-id="zr_0" style="position: absolute; left: 0px; top: 0px; width: 668px; height: 199px; user-select: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); padding: 0px; margin: 0px; border-width: 0px;"></canvas></div><div></div></div>
                        <script type="text/javascript">
                            // 基于准备好的dom，初始化echarts实例
                            var browserchart = echarts.init(document.getElementById('browser') , 'wonderland');

                            var browserchart_option = {
                                title : {
                                    text: '工单状态',
                                    x:'center'
                                },
                                tooltip : {
                                    trigger: 'item',
                                    formatter: "{a} <br/>{b} : {c} ({d}%)"
                                },
                                legend: {
                                    orient: 'vertical',
                                    left: 'left',
                                    data: ["未受理","再追问"]
                                },
                                series : [
                                    {
                                        name: '工单状态',
                                        type: 'pie',
                                        radius : '55%',
                                        center: ['50%', '60%'],
                                        data:[
                                            {value:2, name:"未受理"},{value:1, name:"再追问"}
                                        ],
                                        itemStyle: {
                                            emphasis: {
                                                shadowBlur: 10,
                                                shadowOffsetX: 0,
                                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                                            }
                                        }
                                    }
                                ]
                            };

                            // 使用刚指定的配置项和数据显示图表。
                            browserchart.setOption(browserchart_option);
                        </script>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <h1 class="site-h1 myhold-h1" style="border-top:1px solid #e6e6e6;margin-top:15px;">
                    待处理工单
                </h1>
                <div class="uk-layui-form">
                    <table id="dt_basic" class="table table-striped table-bordered table-hover" width="100%">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    $.get("/restapi/workorders/summary", {}, function (data) {
        root.Console.log('done', data);

        jQuery.each(data, function (i, val) {
            $('.workorder-' + i).html(val);
        });

    }).done(function (data) {
        root.Console.log("submit done!");
    }).fail(function (data) {
        root.Console.log(data);
    }).always(function () {
    });

    var workorderTable = undefined;
    function initTable() {
        workorderTable = commonDataTable({
            "columns": [
                {
                    title: "编号", data: "orderno"},
                {
                    title: "标题", data: "title", "render": function (data, type, full) {
                    return "<a onclick='showdetail(\"" + full.id + "\")' title=\"" + data + "\">" + data + "</a>";
                }
                },
                {title: "联系人", data: "contactsname",},
                {
                    title: "优先级", data: "priorityname", "render": function (data, type, full) {
                    return (data && workorderspriority[data]) ? "<i class='kfont' style='color:#1E9FFF' title='优先级：" + workorderspriority[data] + "'></i>" : data;
                }
                },
                {
                    title: "状态", data: "statusname", "render": function (data, type, full) {
                    return "<small class='ukefu-label' style='background-color:#1E9FFF'>" + ((data && workordersstatus[data]) ? workordersstatus[data] : data) + "</small>";
                }
                },
                {title: "处理人", data: "accusername",},
                {title: "创建时间", data: "createtime",},
            ],

            "fnServerData": function (sSource, aoData, fnCallback) {

                var start = 0;
                var length = 10;
                var columns = null;
                var sEcho = 1;
                var order = [];
                $.each(aoData, function (i, item) {
                    var name = item['name'];
                    var value = item['value'];
                    if (name == "start") {
                        start = value;
                    } else if (name == 'length') {
                        length = value;
                    } else if (name == 'draw') {
                        sEcho = value;
                    } else if (name == 'order') {
                        order = value;
                    } else if (name == 'columns') {
                        columns = value;
                    }
                });

                var orderby = columns[order[0].column].data;
                var direction = order[0].dir;

                var postData = {};
                $.each($('#search-form input'), function (i, item) {
                    var thisObj = $(this);
                    postData[thisObj.attr("name")] = thisObj.val();
                });
                postData.orderby = orderby ? orderby : "createtime";
                postData.direction = direction ? direction : "desc";
                postData.offset = start ? start : 0;
                postData.limit = length ? length : 20;
                postData.type='myhold';
                $.get("/restapi/workorders", postData, function (data) {

                    var content = data;
                    if (!content) {
                        content = {paging: {count: 0, limit: 10, offset: 0}};
                    }
                    content['sEcho'] = sEcho;
                    content['iDisplayStart'] = content.paging.offset;
                    content['iDisplayLength'] = content.paging.limit;
                    content['iTotalRecords'] = content.paging.count;
                    content['iTotalDisplayRecords'] = content.paging.count;
                    content['sortField'] = orderby; //"createTime";
                    content['sortType'] = direction;
                    $('h1.site-h1.myhold-h1').html('待处理工单(' + content['iTotalDisplayRecords'] + ')');
                    fnCallback(content);
                }).done(function (data) {
                    //log('done');
                }).fail(function (data) {
                    if (data.status === 403) {
                        root.Console.log("current request need login!");
                    }
                }).always(function () {
                    //log('always');
                });
            },
            "orderby": "createtime",
            "table": $('#dt_basic'),
        });
    }

    initTable();
</script>
